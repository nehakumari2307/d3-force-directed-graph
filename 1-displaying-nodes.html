<!DOCTYPE html>
<meta charset="utf-8">
<div id="interaction" width="1000" height="1000" style="text-align: center"></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

  function csvToNode(str) {
    var node_data = [];
    for (var i = 0; i < str.length; i++) {
      node_data.push({
        id: str[i].id,
        group: parseInt(str[i].group),
        label: str[i].label,
        level: parseInt(str[i].level),
        strength: parseFloat(str[i].strength)
      });
    }
    return node_data;
  };

  function csvToLink(str) {
    var link_data = [];
    for (var i = 0; i < str.length; i++) {
      link_data.push({
        id: str[i].id,
        target: str[i].target,
        source: str[i].source,
        strength: parseFloat(str[i].strength)
      });
    }
    return link_data;
  };

  d3.csv("./csv_data/node_data.csv", function (error, data) {

    const nodes = csvToNode(data);
    const links = csvToLink(data);
    console.log(nodes);
    console.log(links);

    // var width = window.innerWidth
    // var height = window.innerHeight

    var width = 800;
    var height = 500;
    var strokeWidth = 1;

    // var svg = d3.select('svg')
    // svg.attr('width', width).attr('height', height)

    var svg = d3.select("#interaction").append("svg")
      .attr("height", height)
      .attr("width", width)
      .attr("style", "outline: thin solid black")
      .append("g")
      .attr("transform", "translate(0,0)")

    var linkForce = d3
      .forceLink()
      .id(function (link) { return link.id })
      .strength(function (link) { return link.strength })

    // simulation setup with all forces
    var simulation = d3
      .forceSimulation()
      .force('link', linkForce)
      .force('charge', d3.forceManyBody().strength(-1000))
      .force('center', d3.forceCenter(width / 2, height / 2))

    const draginteraction = d3.drag().on('drag', (event, node) => {
      node.fx = event.x; //fx& fy is used to fix new position of the nodes when dragged
      node.fy = event.y;
      simulation.alpha(1);
      simulation.restart();
    });

    function getNodeColor(node) {
      if (node.level === 0) {
        return 'lightblack';
      } else if (node.level === 1) {
        return 'gray';
      } else {
        return 'lightgray';
      }
    }

    function getTextColor(node) {
      return node.level === 0 ? 'white' : 'black'
    }

    function getNodeStrength(node) {
      return (node.strength * 50) + 1.0;
    }

    var linkElements = svg.append("g")
      .attr("class", "links")
      .selectAll("line")
      .data(links)
      .enter().append("line")
      .attr("stroke-width", strokeWidth)
      .attr("stroke", "rgba(50, 50, 50, 0.5)")


    var nodeElements = svg.append("g")
      .attr("class", "nodes")
      .selectAll("circle")
      .data(nodes)
      .enter().append("circle")
      .attr("r", getNodeStrength)
      .attr("stroke-width", strokeWidth)
      .attr("fill", getNodeColor)
      .call(draginteraction);

    var textElements = svg.append("g")
      .attr("class", "texts")
      .selectAll("text")
      .data(nodes)
      .enter().append("text")
      .text(function (node) { return node.label })
      .attr("text-anchor", "middle")
      .attr("class", "nodetext")
      .attr('alignment-baseline', 'middle')
      .attr("font-size", 18)
      .style("fill", getTextColor)
    // .attr("dx", 15)
    // .attr("dy", 4)

    simulation.nodes(nodes).on('tick', () => {
      nodeElements
        .attr('cx', function (node) { return node.x })
        .attr('cy', function (node) { return node.y })
      textElements
        .attr('x', function (node) { return node.x })
        .attr('y', function (node) { return node.y })
      linkElements
        .attr('x1', function (link) { return link.source.x })
        .attr('y1', function (link) { return link.source.y })
        .attr('x2', function (link) { return link.target.x })
        .attr('y2', function (link) { return link.target.y })
    })
    simulation.force("link").links(links)
  })
</script>